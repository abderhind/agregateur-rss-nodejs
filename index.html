<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aggrégateur de Nouvelles RSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#1e40af',
              'secondary': '#1d4ed8',
              'accent': '#3b82f6',
              'neutral': '#1f2937',
              'base-100': '#111827',
              'base-200': '#1f2937',
              'base-300': '#374151',
            },
          },
        },
      }
    </script>

<!-- <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script> -->

</head>
<body class="bg-base-100 text-gray-200 font-sans">
    <main class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-accent mb-2">
                Aggrégateur de Nouvelles RSS
            </h1>
            <p class="text-gray-400 text-lg">
                Votre source d'information centralisée pour les dernières actualités.
            </p>
        </header>

        <div class="bg-base-200 rounded-lg p-4 mb-8 sticky top-4 z-10 shadow-lg border border-base-300">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Language</label>
                    <div id="language-controls" class="flex flex-wrap gap-2">
                        <!-- Les boutons de langue seront insérés ici par JS -->
                    </div>

                    <label class="block text-sm font-medium text-gray-400 mb-2">Catégorie</label>
                    <div id="category-controls" class="flex flex-wrap gap-2">
                        <!-- Les boutons de catégorie seront insérés ici par JS -->
                    </div>

                </div>

                <div class="md:w-1/3">
                    <label for="article-count" class="block text-sm font-medium text-gray-400 mb-2">
                        Nombre d'articles: <span id="article-count-label" class="font-bold text-accent">10</span>
                    </label>
                    <input
                        id="article-count"
                        type="range"
                        min="5"
                        max="50"
                        step="5"
                        value="10"
                        class="w-full h-2 bg-base-300 rounded-lg appearance-none cursor-pointer accent-accent"
                    />
                </div>
            </div>
        </div>
        
        <div id="news-list-container">
            <!-- Les nouvelles, le chargeur ou l'erreur seront insérés ici -->
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            const state = {
                selectedLanguage: 'EN',
                selectedCategory: 'Technologie',
                articleCount: 10,
                isLoading: true,
                error: null,
                newsItems: [],
            };

            const LANGUAGES=['EN','FR','AR']
            const CATEGORIES = ['Technologie', 'Politique', 'Science', 'Affaires','Culture','Divertissement','Sports'];

            // --- DOM Elements ---
            const languageControls = document.getElementById('language-controls');
            const categoryControls = document.getElementById('category-controls');
            const articleCountSlider = document.getElementById('article-count');
            const articleCountLabel = document.getElementById('article-count-label');
            const newsListContainer = document.getElementById('news-list-container');
            
            // --- UTILITY FUNCTIONS ---
            function formatRelativeTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);

                if (isNaN(seconds) || seconds < 0) return "à l'instant";

                const rtf = new Intl.RelativeTimeFormat('fr', { numeric: 'auto' });

                let interval = seconds / 31536000;
                if (interval > 1) return rtf.format(-Math.floor(interval), 'year');
                
                interval = seconds / 2592000;
                if (interval > 1) return rtf.format(-Math.floor(interval), 'month');

                interval = seconds / 86400;
                if (interval > 1) return rtf.format(-Math.floor(interval), 'day');

                interval = seconds / 3600;
                if (interval > 1) return rtf.format(-Math.floor(interval), 'hour');
                
                interval = seconds / 60;
                if (interval > 1) return rtf.format(-Math.floor(interval), 'minute');

                return rtf.format(-Math.floor(seconds), 'second');
            }

            function cleanHtmlSnippet(html, maxLength = 150) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                if (text.length > maxLength) {
                    return text.substring(0, maxLength).trim() + '...';
                }
                return text;
            }

            // --- RENDER FUNCTIONS ---
            function renderControls() {
                languageControls.innerHTML = '';
                LANGUAGES.forEach(category => {
                    const button = document.createElement('button');
                    button.textContent = category;
                    button.className = `px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-base-200 focus:ring-accent ${
                        state.selectedLanguage === category
                            ? 'bg-accent text-white shadow-md'
                            : 'bg-base-300 text-gray-300 hover:bg-gray-600'
                    }`;
                    button.addEventListener('click', () => {
                        state.selectedLanguage = category;
                        renderControls();
                        fetchNews();
                    });
                    languageControls.appendChild(button);
                });
                
                
                ///////
                categoryControls.innerHTML = '';
                CATEGORIES.forEach(category => {
                    const button = document.createElement('button');
                    button.textContent = category;
                    button.className = `px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-base-200 focus:ring-accent ${
                        state.selectedCategory === category
                            ? 'bg-accent text-white shadow-md'
                            : 'bg-base-300 text-gray-300 hover:bg-gray-600'
                    }`;
                    button.addEventListener('click', () => {
                        state.selectedCategory = category;
                        renderControls();
                        fetchNews();
                    });
                    categoryControls.appendChild(button);
                });

            }

            function render() {
                newsListContainer.innerHTML = ''; // Clear previous content

                if (state.isLoading) {
                    newsListContainer.innerHTML = `
                        <div class="flex justify-center items-center py-20">
                            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-accent"></div>
                            <span class="sr-only">Chargement...</span>
                        </div>
                    `;
                    return;
                }

                if (state.error) {
                    newsListContainer.innerHTML = `
                        <div class="text-center py-10 px-4 bg-red-900/20 border border-red-500 rounded-lg">
                            <h3 class="text-xl font-semibold text-red-400">Oops! Une erreur est survenue.</h3>
                            <p class="text-red-300 mt-2">${state.error}</p>
                        </div>
                    `;
                    return;
                }

                if (!state.newsItems.length) {
                    newsListContainer.innerHTML = `
                        <div class="text-center py-10 px-4 bg-base-200 border border-base-300 rounded-lg">
                            <h3 class="text-xl font-semibold text-gray-400">Aucun article trouvé.</h3>
                            <p class="text-gray-500 mt-2">Essayez de sélectionner une autre catégorie ou de rafraîchir la page.</p>
                        </div>
                    `;
                    return;
                }
                
                const grid = document.createElement('div');
                grid.className = "grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4";
                
                state.newsItems.forEach(item => {
                    const snippet = cleanHtmlSnippet(item.snippet);
                    const card = document.createElement('div');
                    card.className = "bg-base-200 border border-base-300 rounded-lg shadow-lg overflow-hidden flex flex-col hover:border-accent transition-colors duration-300 transform hover:-translate-y-1";
                    card.innerHTML = `
                        <div class="p-5 flex-grow flex flex-col">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-xs font-semibold uppercase tracking-wider text-accent bg-accent/20 px-2 py-1 rounded">
                                    ${item.source}
                                </span>
                                <span class="text-xs text-gray-400">${formatRelativeTime(item.pubDate)}</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-100 flex-grow">
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="hover:text-accent transition-colors duration-200">
                                    ${item.title}
                                </a>
                            </h3>
                            ${snippet ? `<p class="text-gray-400 mt-2 text-sm">${snippet}</p>` : ''}
                        </div>
                        <div class="px-5 py-3 bg-base-300/50">
                            <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-accent hover:underline flex items-center gap-1">
                                Lire l'article
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                                </svg>
                            </a>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                newsListContainer.appendChild(grid);
            }

            // --- DATA FETCHING ---
            async function fetchNews() {
                state.isLoading = true;
                state.error = null;
                render();

                try {
                    // const lang="en"
                    const response = await fetch(`/rss?category=${encodeURIComponent(state.selectedCategory)}&count=${state.articleCount}&lang=${state.selectedLanguage}`);
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || `Erreur: ${response.statusText}`);
                    }
                    const data = await response.json();
                    state.newsItems = data;
                } catch (e) {
                    state.error = e.message;
                    state.newsItems = [];
                } finally {
                    state.isLoading = false;
                    render();
                }
            }

            // --- EVENT LISTENERS ---
            articleCountSlider.addEventListener('input', (e) => {
                state.articleCount = parseInt(e.target.value, 10);
                articleCountLabel.textContent = state.articleCount;
            });
            
            // Use 'change' event to fetch only when user releases the slider
            articleCountSlider.addEventListener('change', () => {
                fetchNews();
            });

            // --- INITIALIZATION ---
            function init() {
                renderControls();
                fetchNews();
            }

            init();
        });
    </script>
</body>
</html>